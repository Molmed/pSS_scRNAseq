---
output: html_document
editor_options: 
  chunk_output_type: console
---


# DE tests and Visualization {#DE-tests}
## Load packages

```{r}

source("./00_dependencies.R")

```


## Load data

```{r}

gex <- readRDS("../results/GEX5_DIMRED2.rds")

```


## get B-cell cluster marker genes

```{r}

sample_size <- table(gex$seurat_clusters)
sample_size[sample_size > 100] <- 100
DGE_cells <- lapply(names(sample_size), function(x) {
  set.seed(1)
  sample(colnames(gex)[gex$seurat_clusters == x], size = sample_size[x])
})
DGE_cells <- unlist(DGE_cells)
DGE_temp<- gex[, DGE_cells]
DGE_temp <- SetIdent(DGE_temp, value = "seurat_clusters")
detable <- FindAllMarkers( DGE_temp, 
                           min.pct = 0.1, 
                           min.cells.feature = 0.1, 
                           max.cells.per.ident = 200 , 
                           only.pos = T , 
                           logfc.threshold = 0.1, 
                           assay = "RNA" )

detable$pct.diff <- detable$pct.1 - detable$pct.2
write.csv(detable, 
          paste0("../results/DGE_B-cells_seurat_clusters.csv"))
detable <- read.csv("../results/DGE_B-cells_seurat_clusters.csv", stringsAsFactors = FALSE, sep = ";")

detable <- detable[detable$p_val < 0.05,  ]
detable$log.pct.diff <- log2(detable$pct.1 / (detable$pct.2 + 0.01) )

detable %>% group_by(cluster) %>%  top_n(-30, p_val)  %>% top_n(20, log.pct.diff) -> top5
ord <- factor(sapply(unique(as.character(top5$gene)),
                     function(x) {
                       getcluster(DGE_temp, x, "seurat_clusters")
                     }))
genes_to_plot <- unique(as.character(top5$gene))[order(as.numeric( as.character(ord) ))]

pdf(paste0("../results/DGE_B-cells_seurat_clusters_dotplot.pdf"), 
    width = 10, height = length(genes_to_plot)/4+3 )
rafalib::mypar(1, 1, mar = c(6, 6, 1, 5))
plot_dots(DGE_temp, 
          genes_to_plot, 
          clustering = "seurat_clusters", 
          show_grid = T, 
          main = "top cluster markers", 
          cex.main = 1, font.main = 1, cex.col = 1.3, srt = 0, cex.row = 1.3)
dev.off()

# detable[detable$gene=="FCER1G",]
# rafalib::mypar(2, 1, mar=c(1,1,2,4))
# plot_feat(gex,red="umap_2",feat="FCER1G",cex=.8)


```

## test overlaps between clusters and known B-cell subsets

```{r}

king <- read.table("/Users/gusarv/Documents/GA/papers/king2021/abe6291_table_s9.txt", 
                   sep ="\t", 
                   header =TRUE, 
                   stringsAsFactors = FALSE)
king$cluster <- gsub(" ", "_", king$cluster)

fdrcutoff <- 0.2

#intersecting genes
overlap <- data.frame()
for (i in 1:length((unique(detable$cluster)))){
  for (j in 1:length((unique(king$cluster)))){
    
        overlap[i, j]  <- length(intersect(detable$gene[detable$p_val_adj <= fdrcutoff  & detable$cluster == i],
                                 king$gene[king$p_val_adj <= fdrcutoff  & 
                                             king$cluster == unique(king$cluster)[j]]))
    colnames(overlap)[j] <- unique(king$cluster)[j]
  }
  
  rownames(overlap)[i] <- unique(detable$cluster)[i]
  
}



## fisher exact test
overlap.p <- data.frame()
for (i in 1:length((unique(detable$cluster)))){
  for (j in 1:length((unique(king$cluster)))){
    
        ###fisher exact test
        A <- length(intersect(detable$gene[detable$p_val_adj <= fdrcutoff & 
                                             detable$cluster == unique(detable$cluster)[i]],
                                         king$gene[king$p_val_adj <= fdrcutoff & 
                                                     king$cluster == unique(king$cluster)[j]]))
        B <- length(detable$gene[detable$p_val_adj <= fdrcutoff & 
                                   detable$cluster == unique(detable$cluster)[i]])-A
        C <- length(king$gene[king$p_val_adj <= fdrcutoff & 
                                king$cluster == unique(king$cluster)[j]])-A
        D <- length(intersect(unique(king$gene), unique(detable$gene)))-A-B-C #all common genes
        
        cat(unique(detable$cluster)[i], "\n")
        cat(unique(king$cluster)[j], "\n")
        
        overlap.table <- matrix(c(A, B,
                                  C, D), nrow = 2, byrow = T)
        
        cat(overlap.table, "\n")
        
        fisher.test.result <- fisher.test(overlap.table, alternative = "greater")

        overlap.p[i, j]  <- fisher.test.result$p.value
        
        cat(fisher.test.result$p.value, "\n","\n")
        
    colnames(overlap.p)[j] <- unique(king$cluster)[j]
    
  }
  
  rownames(overlap.p)[i] <- unique(detable$cluster)[i]
  
}

## prop
overlap.prop <- data.frame()

for (i in 1:length((unique(detable$cluster)))){
  for (j in 1:length((unique(king$cluster)))){
    
        ###fisher exact test
        A <- length(intersect(detable$gene[detable$p_val_adj < fdrcutoff & 
                                             detable$cluster == unique(detable$cluster)[i]],
                                         king$gene[king$p_val_adj < fdrcutoff & 
                                                     king$cluster == unique(king$cluster)[j]]))
        B <- min(length(detable$gene[detable$p_val_adj < fdrcutoff & 
                                   detable$cluster == unique(detable$cluster)[i]]),length(king$gene[king$p_val_adj < fdrcutoff & 
                                king$cluster == unique(king$cluster)[j]]))
       
        
        cat(unique(detable$cluster)[i], "\n")
        cat(unique(king$cluster)[j], "\n")
        
        cat(round(A / B * 100, digits = 2), "\n")

        overlap.prop[i, j]  <- round(A / B * 100, digits = 1)
        
    colnames(overlap.prop)[j] <- unique(king$cluster)[j]
    
  }
  
  rownames(overlap.prop)[i] <- unique(detable$cluster)[i]
  
}


annot_row <- data.frame(unique(gex@meta.data[, c("seurat_clusters", "BcelltypeMain")])[match(rownames(overlap), unique(gex@meta.data[, c("seurat_clusters", "BcelltypeMain")])$seurat_clusters),])
rownames(annot_row) <- 0:22
colnames(annot_row) <- c("cluster", "cell")
annot_row$cluster <- NULL

pheatmap::pheatmap(overlap.p, 
                   breaks = seq(0, 1, length.out = 100),
                   color = colorRampPalette(c("lightblue","firebrick"))(99),
                   display_numbers = overlap,
                   #display_numbers = round(overlap.p, digits = 2),
                   cluster_rows = FALSE,
                   cluster_cols = FALSE,
                   filename = "../results/cluster_intersect_king_et_al2021_memory_count.pdf",
                   annotation_row =  annot_row)

pheatmap::pheatmap(overlap, 
                   breaks = seq(0, 100, length.out = 100),
                   color = colorRampPalette(c("lightblue","firebrick"))(99),
                   #display_numbers = overlap,
                   display_numbers = round(overlap.p, digits = 2),
                   cluster_rows = FALSE,
                   cluster_cols = FALSE,
                   filename = "../results/cluster_intersect_king_et_al2021_memory_p.pdf",
                   annotation_row =  annot_row)

pheatmap::pheatmap(overlap.p, 
                   breaks = seq(0, 1, length.out = 100),
                   color = colorRampPalette(c("lightblue","firebrick"))(99),
                   #display_numbers = overlap,
                   display_numbers = round(overlap.prop, digits = 2),
                   cluster_rows = FALSE,
                   cluster_cols = FALSE,
                   filename = "../results/cluster_intersect_king_et_al2021_memory_prop.pdf",
                   annotation_row =  annot_row,
                   main = "Numbers are proportion of intersect in smallest class
                   and colors indicate fisher exact test p-value")




```

## plot marker gene expression

```{r}

plotExpression()

b_features <- c("IGHD", "AICDA", "BCL6", "MKI67", "CD83", "CD38", "CXCR4", "LY6D", "CD1D", "FOXO1", 
                "CCR6", "IRF4", "SDC1", "PRDM1", "CD9", "CCR7", "EBF1", "CD74", "NR4A1" , "SLPI", "SDC1")
b_features2 <- c("RB1", "NT5E", "CD27", "CD19", "ITGAX", "FAS")
b_features3 <-  c("CD38", "PTPRC")
b_trans <- c("CD24", "CD38", "MME", "IGHM")
ig.features <- c("IGHA1", "IGHA2", "IGHG1", "IGHG2", "IGHG3", "IGHG4",  "IGHD", "IGHE", "IGHM")

VlnPlot(gex, features = b_trans, group.by = "seurat_clusters", slot = "data", log = TRUE, ncol = 4)

p1 <- VlnPlot(gex, 
              features = ig.features, 
              group.by = "seurat_clusters", 
              slot = "data", log = TRUE, ncol = 3)
ggsave2("../results/VlnPlot_markers_ig.features.png", 
        p1, 
        width = 30, height = 30, unit = "cm")

p1 <- RidgePlot(gex, features = ig.features, group.by = "seurat_clusters", slot = "data", log = TRUE, ncol = 3)
ggsave2("../results/RidgePlot_markers_ig.features.png", 
        p1, 
        width = 30, height = 30, unit = "cm")

p2 <- VlnPlot(gex, features = b_features3, group.by = "seurat_clusters", slot = "data", log = FALSE, ncol = 3)
ggsave2("../results/VlnPlot_markers_b_features_3.png", 
        p2, 
        width = 20, height = 10, unit = "cm")

p2 <- RidgePlot(gex, features = b_features, group.by = "seurat_clusters", slot = "data", log = TRUE, ncol = 3)
ggsave2("../results/RidgePlot_markers_b_features.png", 
        p2, 
        width = 20, height = 60, unit = "cm")


plot_grid(p1, p2, ncol = 2, labels = "AUTO", align = "h")
```


## Annotating B-cell clusters 

```{r}

#general
#Naive - 
#Transitional - "CD24", "CD38", "CD10", "IGHM"  c("CD24", "CD38", "MME", "IGHM")
#Transitional_T1 -  c("CD24", "CD38", "MME", "IGHM")
#Transitional_T2 -  CD24", "CD38", "MME", "IGHM", "IGHD", "CD21", "CD23" 
#c("CD24", "CD38", "MME", "IGHM", "IGHD", "CR2", "FCER2")
#Memory - c("CD27)
#Plasma cells - CD138 "SDC1"

#Breg - "IL10"

#https://pubmed.ncbi.nlm.nih.gov/34161770/
# C4 - MZ - CD1D (Cd1d1), CD9 (Cd9)
# Naive - 
# Naive/Activated - 
# PreGC - 
# EarlyGZ - 
# GC-DZ/G2M - 
# GC-DZ/S - 
# GC-LZ - 
# GC-LZ/S - 
# GC-LZ/G2M - 
# PreMem - 
# Bmem - 
# PB - 


 
# https://pubmed.ncbi.nlm.nih.gov/32668225/
# Plasma
# Transitional
# Naive CD73-
# Naive CD73+
# Memory RB+ CD27-
# Memory RB-
# Memory RB+ CD27+ CD73+
# Memory RB+ CD27+ CD73-
# Memory CD19high CD11c+
# Memory CD95+

# RB - RB1
# CD73 - NT5E
# CD27
# CD19
# CD11c - ITGAX
# CD95 - FAS



#manual cluster annotation
annotation_main <- c(
  Naive = 0,
  Naive = 1,
  Naive = 2,
  Memory = 3,
  Naive = 4,
  Memory = 5,
  Naive = 6,
  Memory = 7,
  B_tissueMigration = 8,
  Memory = 9,
  Naive = 10,
  Memory = 11,
  Memory = 12,
  Memory = 13,
  Memory = 14,
  Memory = 15,
  Memory = 16,
  Memory = 17,
  B_tissueMigration = 18,
  Unknown = 19,
  Naive = 20,
  B_stressed = 21,
  Plasma_cell = 22
)

# annotation <- c(
#   x = 0,
#   x = 1,
#   x = 2,
#   x = 3,
#   x = 4,
#   x = 5,
#   x = 6,
#   x = 7,
#   x = 8,
#   `Memory CD95+` = 9,
#   `Naive CD73+` = 10,
#   x = 11,
#   x = 12,
#   `Memory CD95+` = 13,
#   `Memory` = 14,
#   `Memory CD19high CD11c+` = 15,
#   x = 16,
#   `Memory RB+ CD27+ CD73+` = 17,
#   x = 18,
#   x = 19,
#   x = 20,
#   x = 21,
#   `Plasma cell` = 22
# )

#gex$Bcelltype <- names(annotation)[match(gex$seurat_clusters, annotation)] 
gex$BcelltypeMain <- names(annotation_main)[match(gex$seurat_clusters, annotation_main)] 
table(gex$BcelltypeMain)
DimPlot(gex, 
              group.by = "BcelltypeMain", 
              split.by = "patient_group", 
              reduction = "umap_2", ncol = 2, raster = FALSE) 


```


## Save rds GEX6_BANNOT.rds

```{r}

saveRDS(gex, file = "../results/GEX6_BANNOT.rds")

```


## Print sessionInfo()

```{r}

sessionInfo()

```



