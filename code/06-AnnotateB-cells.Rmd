---
output: html_document
editor_options: 
  chunk_output_type: console
---


# annotation of B-cell clusters {#B-cell_annotation}
## Load packages

```{r}

source("./00_dependencies.R")

```


## Load data

```{r}

gex <- readRDS("../results/GEX5_DIMRED2.rds")

```


## get cell cycle score

```{r}

# gex <- CellCycleScoring(gex, 
#                         s.features = cc.genes$s.genes, 
#                         g2m.features = cc.genes$g2m.genes, 
#                         set.ident = FALSE)
# 
# DimPlot(gex, reduction = "umap_2", group.by = "Phase", split.by = "cluster_cellType_manual_main")
# 
# table(gex$Phase, gex$orig.ident)
# 
# colnames(gex@meta.data)
# 
# res <- table(gex$Phase, gex$orig.ident)
# res <- table(gex$Phase, gex$cluster_cellType_manual_fine)
# res2 <- t( t(res) / colSums(res))



```

## get B-cell cluster marker genes

```{r}

sample_size <- table(gex$seurat_clusters)
sample_size[sample_size > 100] <- 100
DGE_cells <- lapply(names(sample_size), function(x) {
  set.seed(1)
  sample(colnames(gex)[gex$seurat_clusters == x], size = sample_size[x])
})
DGE_cells <- unlist(DGE_cells)
DGE_temp<- gex[, DGE_cells]
DGE_temp <- SetIdent(DGE_temp, value = "seurat_clusters")
detable <- FindAllMarkers( DGE_temp, 
                           min.pct = 0.1, 
                           min.cells.feature = 0.1, 
                           max.cells.per.ident = 200, 
                           only.pos = TRUE, 
                           logfc.threshold = 0.1, 
                           assay = "RNA" )

detable$pct.diff <- detable$pct.1 - detable$pct.2
write.csv(detable, 
          paste0("../results/DGE_B-cells_seurat_clusters.csv"))
detable <- read.csv("../results/DGE_B-cells_seurat_clusters.csv", stringsAsFactors = FALSE, sep = ";")

detable <- detable[detable$p_val < 0.05,  ]
detable$log.pct.diff <- log2(detable$pct.1 / (detable$pct.2 + 0.01) )

detable %>% group_by(cluster) %>%  top_n(-30, p_val)  %>% top_n(20, log.pct.diff) -> top5
ord <- factor(sapply(unique(as.character(top5$gene)),
                     function(x) {
                       getcluster(DGE_temp, x, "seurat_clusters")
                     }))
genes_to_plot <- unique(as.character(top5$gene))[order(as.numeric( as.character(ord) ))]

pdf(paste0("../results/DGE_B-cells_seurat_clusters_dotplot.pdf"), 
    width = 10, height = length(genes_to_plot) / 4 + 3 )
rafalib::mypar(1, 1, mar = c(6, 6, 1, 5))
plot_dots(DGE_temp, 
          genes_to_plot, 
          clustering = "seurat_clusters", 
          show_grid = TRUE, 
          main = "top cluster markers", 
          cex.main = 1, font.main = 1, cex.col = 1.3, srt = 0, cex.row = 1.3)
dev.off()


```


## integrate with stewart et al. 2021 per cell using scPred()

```{r}
#https://pubmed.ncbi.nlm.nih.gov/33815362/

stewart <- readRDS("../suppl/Stewart_et_al_2021/E-MTAB-9544_rds/scPure2_HB6_UMAP3D.rds")

VlnPlot(stewart, c("nCount_RNA","nFeature_RNA", "percent.mt"), group.by = "library_id")

#filter and process
stewart <- subset(stewart, subset = nFeature_RNA > 200 & nFeature_RNA < 3000 & percent.mt < 10)
#stewart <- stewart[rowSums(stewart@assays$RNA@counts) != 0, ]

# stewart <- stewart %>%
#   NormalizeData() %>% 
#   FindVariableFeatures() %>% 
#   ScaleData() %>% 
#   RunPCA() %>% 
#   RunUMAP(dims = 1:50)


####------------- per sorted cell type

#subset Stewart seurat object
Idents(object = stewart) <- "library_id"
stewart.lid.300 <- subset(stewart, downsample = 300)

#train model
ref1 <- getFeatureSpace(stewart.lid.300, "library_id")
ref1 <- trainModel(ref1)
get_scpred(ref1)

saveRDS(ref1, "../results/stewart_ref1_library_id.rds")

#predict cell types
gex <- scPredict(gex, ref1)

#rename columns in seurat meta.data 
scPredcols <- c("scpred_max", "scpred_prediction", "scpred_no_rejection")
names(gex@meta.data)[names(gex@meta.data) == scPredcols[1]] <- paste0(scPredcols[1], "_ref1")
names(gex@meta.data)[names(gex@meta.data) == scPredcols[2]] <- paste0(scPredcols[2], "_ref1")
names(gex@meta.data)[names(gex@meta.data) == scPredcols[3]] <- paste0(scPredcols[3], "_ref1")
names(gex@meta.data)[names(gex@meta.data) == "scpred_Naive"] <- "scpred_Naive_"

#plot
p1 <- DimPlot(gex, 
              group.by = "scpred_prediction_ref1", 
              reduction = "umap_2") + 
  xlab("UMAP 1") + 
  ylab("UMAP 2") +
  ggtitle("predicted cell type, Stewart et al. 2021", subtitle = "by sorted cell type")


####------------- per stewart cluster
#subset seurat object
Idents(object = stewart) <- "cluster"
stewart.cl.300 <- subset(stewart, downsample = 300)
head(stewart.cl.300@meta.data)
table(stewart.cl.300$cluster)

#train model
ref2 <- getFeatureSpace(stewart.cl.300, "cluster")
ref2 <- trainModel(ref2)
get_scpred(ref2)

# |Cell type |   n| Features|Method    |   ROC|  Sens|  Spec|
# |:---------|---:|--------:|:---------|-----:|-----:|-----:|
# |Trans     | 300|       50|svmRadial | 0.999| 0.950| 0.993|
# |Naive     | 300|       50|svmRadial | 0.984| 0.817| 0.986|
# |M-mem1    | 300|       50|svmRadial | 0.978| 0.780| 0.978|
# |M-mem2    | 300|       50|svmRadial | 0.944| 0.527| 0.970|
# |C-mem1    | 300|       50|svmRadial | 0.959| 0.617| 0.977|
# |C-mem2    | 300|       50|svmRadial | 0.985| 0.763| 0.982|
# |DN1       | 300|       50|svmRadial | 0.972| 0.733| 0.987|
# |DN2       | 300|       50|svmRadial | 0.998| 0.930| 0.993|
# |DN3       | 300|       50|svmRadial | 0.914| 0.437| 0.974|
# |DN4       | 300|       50|svmRadial | 0.969| 0.690| 0.984|

saveRDS(ref2, "../results/stewart_ref2_cluster.rds")

#predict cell types
gex <- scPredict(gex, ref2)

#rename columns in seurat meta.data 
names(gex@meta.data)[names(gex@meta.data) == scPredcols[1]] <- paste0(scPredcols[1], "_ref2")
names(gex@meta.data)[names(gex@meta.data) == scPredcols[2]] <- paste0(scPredcols[2], "_ref2")
names(gex@meta.data)[names(gex@meta.data) == scPredcols[3]] <- paste0(scPredcols[3], "_ref2")

#plot
p2 <- DimPlot(gex, 
              group.by = "scpred_prediction_ref2", 
              reduction = "umap_2") + 
  xlab("UMAP 1") + 
  ylab("UMAP 2") +
  ggtitle("predicted cell type, Stewart et al. 2021", 
          subtitle = "by clustered sorted celltype")


dev.off()
#check cluster overlap with cell types
#per sorted cell type
hm1 <- round(sweep(as.data.frame.matrix(table(gex$seurat_clusters, 
                                              gex$scpred_prediction_ref1)), 
                   1, table(gex$seurat_clusters), `/`) * 100, 
             digits = 1)

phm1 <- pheatmap(hm1, 
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         main = "Sorted Cell Type, % of seurat cluster", 
         display_numbers = TRUE,
         filename = "../results/cellType_B-cells_Stewart_et_al_1.png", 
         number_format = "%.1f")

#per sorted cell type cluster
hm2 <- round(sweep(as.data.frame.matrix(table(gex$seurat_clusters, 
                                              gex$scpred_prediction_ref2)), 
                   1, table(gex$seurat_clusters), `/`) * 100, 
             digits = 1)

phm2 <- pheatmap(hm2, 
         cluster_rows = FALSE, 
         cluster_cols = FALSE,
         main = "Clustered Sorted Cell Type, % of seurat cluster", 
         display_numbers = TRUE,
         filename = "../results/cellType_B-cells_Stewart_et_al_2.png",
         number_format = "%.1f") 


p3 <- tableGrob(table(gex$scpred_prediction_ref1, gex$scpred_prediction_ref2))

p4 <- plot_grid(p1, p2, phm1[[4]], phm2[[4]], ncol = 2, labels = NULL) + bgcolor("white")

ggsave2(paste0("../results/cellType_Stewart_perCell.png"), 
        plot_grid(p4, p3, ncol = 1, labels = NULL, rel_heights = c(4, 1)) + bgcolor("white"), 
        width = 30, height = 30, unit = "cm")


#add cluster cell type classification based on fraction of predicted cell type in cluster
annot.df <- data.frame(cluster = rownames(hm1), 
                       annot_sort = colnames(hm1)[apply(hm1, 1, which.max)], 
                       annot_clust = colnames(hm2)[apply(hm2, 1, which.max)])
  
gex@meta.data["cluster_stewart_sort"] <- annot.df$annot_sort[match(gex$seurat_clusters,
                                                           annot.df$cluster)]

gex@meta.data["cluster_stewart_cl"] <- annot.df$annot_clust[match(gex$seurat_clusters,
                                                           annot.df$cluster)]

table(gex@meta.data$cluster_stewart_sort, gex@meta.data$cluster_stewart_cl)


```


## manual annotation using output from scPred and cluster marker genes

```{r}

annotation_fine <- c(
  Naive = 0,#CCR7, BACH2, SELL, IL4R
  Naive = 1,#IGHD,FCER2
  Naive = 2,#IGHD,FCER2
  IgM_Memory = 3,
  Transitional = 4,# CD9, IGHD,FCER2
  Classical_Memory = 5,
  Naive_IFN = 6,#CCR7, BACH2, SELL, IL4R, IGHD, FCER2, + IFN regulated genes
  DN2 = 7, #IGHA1
  Classical_Memory_stressed = 8,
  DN_ID3 = 9, #ID3, LGALS3, ITGB1, IGHA1
  Naive = 10,#COL19A1, CCR7, BACH2, SELL, IL4R, IGHD,FCER2
  DN_IGHE = 11, #IGHE, IL13RA (allergy)
  IgM_Memory = 12, #?? early memory?, no concrete marker, down regulates "naive genes"
  DN2_CXCR3 = 13, #ITGB7, IGHG1, IGHG2, IGHG3, CXCR3, IGHA1
  IgM_Memory_CD1C = 14,#CD1C
  DN2_ITGAX = 15, #FCRL3, MPP6, ARL4D, ZEB2, ITGAX, ITGB7, IGHA1
  Classical_Memory = 16, #IGHA
  IgM_Memory_ALOX5 = 17, #?? ALOX5, ACADM, GID8, CMSS1
  Classical_Memory_CD69_stressed = 18, #FOS, CD69, EGR1, DUSP1
  Memory_Platlet = 19, #CCL5, F13A1, PPBP, NRGN, CLU
  Naive = 20,#
  Classical_Memory_stressed = 21,#dead/dying cells
  Plasma_cell = 22
)

gex@meta.data["cluster_cellType_manual_fine"] <- names(annotation_fine)[match(gex$seurat_clusters,
                                                                     annotation_fine)] 

annotation_main <- c(
  Naive = 0,#CCR7, BACH2, SELL, IL4R
  Naive = 1,#IGHD,FCER2
  Naive = 2,#IGHD,FCER2
  Memory = 3,
  Transitional = 4,# CD9, IGHD,FCER2
  Memory = 5,
  Naive = 6,#CCR7, BACH2, SELL, IL4R, IGHD,FCER2, + IFN regulated genes
  DN = 7, #IGHA1
  Memory_stressed = 8,
  DN = 9, #ID3, LGALS3, ITGB1, IGHA1
  Naive = 10,#COL19A1, CCR7, BACH2, SELL, IL4R, IGHD,FCER2
  DN = 11, #IGHE, IL13RA1 (allergy)
  Memory = 12, #?? early memory?, no concrete marker, down regulates "naive genes"
  DN = 13, #ITGB7, IGHG1, IGHG2, IGHG3, CXCR3, IGHA1
  Memory = 14,#CD1C
  DN = 15, #FCRL3, MPP6, ARL4D, ZEB2, ITGAX, ITGB7, IGHA1
  Memory = 16, #IGHA1
  Memory = 17, #?? ALOX5, ACADM, GID8, CMSS1
  Memory_stressed = 18, #FOS, CD69, EGR1, DUSP1
  Memory_Platlet = 19, #CCL5, F13A1, PPBP, NRGN, CLU
  Naive = 20,#
  Memory_stressed = 21,#dead/dying cells
  Plasma_cell = 22
)

gex@meta.data["cluster_cellType_manual_main"] <- names(annotation_main)[match(gex$seurat_clusters,
                                                                     annotation_main)] 


table(gex@meta.data$cluster_cellType_manual_fine, gex@meta.data$cluster_cellType_manual_main)

p1 <- DimPlot(gex, group.by = "cluster_stewart_sort", reduction = "umap_2") + xlab("UMAP 1") + ylab("UMAP 2")+ 
  xlab("UMAP 1") + 
  ylab("UMAP 2") +
  ggtitle("Stewart et al. 2021 celltypes", 
          subtitle = "by clustered sorted celltype")
p2 <- DimPlot(gex, group.by = "cluster_stewart_cl", reduction = "umap_2") + xlab("UMAP 1") + ylab("UMAP 2")
p3 <- DimPlot(gex, group.by = "cluster_cellType_manual_fine", reduction = "umap_2") + xlab("UMAP 1") + ylab("UMAP 2")
p4 <- DimPlot(gex, group.by = "cluster_cellType_manual_main", reduction = "umap_2") + xlab("UMAP 1") + ylab("UMAP 2")
p5 <- plot_grid(p1, p2, p3, p4, ncol = 2) +  bgcolor("white")
#p6 <- plot_grid(phm1[[4]], phm2[[4]], ncol = 2) + bgcolor("white")
p7 <- tableGrob(table(gex@meta.data$cluster_stewart_sort, gex@meta.data$cluster_stewart_cl))

ggsave2(paste0("../results/cellType_Stewart_perCluster.png"), 
        plot_grid(p5, p7, ncol = 1, rel_heights = c(4, 1)) + bgcolor("white"), 
        width = 40, height = 30, unit = "cm")


```


## plot marker gene expression

```{r}

plotExpression()

b_features <- c("IGHD", "AICDA", "BCL6", "MKI67", "CD83", "CD38", "CXCR4", "LY6D", "CD1D", "FOXO1", 
                "CCR6", "IRF4", "SDC1", "PRDM1", "CD9", "CCR7", "EBF1", "CD74", "NR4A1" , "SLPI", "SDC1")
b_features2 <- c("RB1", "NT5E", "CD27", "CD19", "ITGAX", "FAS")
b_features3 <-  c("CD38", "PTPRC")
b_trans <- c("CD24", "CD38", "MME", "IGHM")
ig.features <- c("IGHA1", "IGHA2", "IGHG1", "IGHG2", "IGHG3", "IGHG4",  "IGHD", "IGHE", "IGHM")

c_features <- c("CCR7", "BACH2", "SELL", "IL4R", "IGHD", "FCER2", "IGHA1", "ID3", "LGALS3", "ITGB1", "COL19A1", "IGHE", "IL13RA1", "ITGB7", "IGHG1", "IGHG2", "IGHG3", "CXCR3", "IGHA1", "ALOX5", "ACADM", "GID8", "CMSS1", "FOS", "CD69", "EGR1", "DUSP1", "CCL5", "F13A1", "PPBP", "NRGN", "CLU")
c_features <- c_features[order(c_features)]

p1 <- VlnPlot(gex, 
              features = c_features, 
              group.by = "seurat_clusters", 
              slot = "data", 
              log = TRUE, 
              ncol = 2)

ggsave2("../results/VlnPlot_clusterMarkers.png", 
        p1, 
        width = 20, height = 80, unit = "cm")


p1 <- RidgePlot(gex, features = ig.features, group.by = "seurat_clusters", slot = "data", log = TRUE, ncol = 3)
ggsave2("../results/RidgePlot_markers_ig.features.png", 
        p1, 
        width = 30, height = 30, unit = "cm")

p2 <- VlnPlot(gex, features = b_features3, group.by = "seurat_clusters", slot = "data", log = FALSE, ncol = 3)
ggsave2("../results/VlnPlot_markers_b_features_3.png", 
        p2, 
        width = 20, height = 10, unit = "cm")

p2 <- RidgePlot(gex, features = b_features, group.by = "seurat_clusters", slot = "data", log = TRUE, ncol = 3)
ggsave2("../results/RidgePlot_markers_b_features.png", 
        p2, 
        width = 20, height = 60, unit = "cm")


plot_grid(p1, p2, ncol = 2, labels = "AUTO", align = "h")


```


## Save rds GEX6_BANNOT.rds

```{r}

saveRDS(gex, file = "../results/GEX6_BANNOT.rds")

```


## Print sessionInfo()

```{r}

sessionInfo()

```



