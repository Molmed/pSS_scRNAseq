---
output: html_document
editor_options: 
  chunk_output_type: console
---
# VDJ Integration


## load packages

```{r include = FALSE}

source("./00_dependencies.R")
devtools::install_github("ncborcherding/scRepertoire")
devtools::install_github("ncborcherding/scRepertoire@dev")
devtools::install_github("ncborcherding/scRepertoire@refine")
library(scRepertoire)


```


## read seurat object

```{r include = FALSE}
library(niceRplots)
saveRDS(gex, file = paste0("../suppl/GEX14_", format(Sys.time(), "%y%m%d"), ".rds"))
gex <- readRDS("../suppl/GEX14_210628.rds")
sort(sapply(ls(), function(x){format(object.size(get(x)), units = "Gb")}))
colnames(gex)
gex@assays$RNA@scale.data <- matrix(0); gc()
# gex@assays$RNA@scale.data <- matrix(0)
saveRDS(gex,"../results/B-cells.rds")

plot_meta(gex,"umap_2",feat = "seurat_clusters")
```


## read 10x VDJ files

```{r}

# read 10x VDJ BCR files
fl_vdj_B <- list.files("../data/clono_VDJ",pattern = "_B_")
cl_vdj_B <- lapply(fl_vdj_B, function(x){
  return(read.csv(paste0("../data/clono_VDJ/", x)))
})
names(cl_vdj_B) <- sub("_.*", "", fl_vdj_B)
#length(cl_vdj_B)
#str(cl_vdj_B)
#head(cl_vdj_B[[1]])

combineBCR()

combined <- combineBCR(cl_vdj_B, 
                       samples = sub("_.*", "", fl_vdj_B), 
                       #ID = sub("_.*", "", fl_vdj_B),
                       ID = rep("", times = length(cl_vdj_B)),
                       removeNA = FALSE,
                       removeMulti = TRUE) #Error: vector memory exhausted (limit reached?)


# read 10x VDJ TCR files
fl_vdj_T <- list.files("../data/clono_VDJ",pattern = "_T_")
cl_vdj_T <- lapply(fl_vdj_T, function(x){
  return(read.csv(paste0("../data/clono_VDJ/", x)))
})
names(cl_vdj_T) <- sub("_.*", "", fl_vdj_T)
head(cl_vdj_T[[1]])

combined <- combineTCR(cl_vdj_T, 
                       samples = sub("_.*", "", fl_vdj_T), 
                       #ID = sub("_.*", "", fl_vdj_T),
                       ID = rep("", times = length(cl_vdj_T)),
                       removeNA = FALSE,
                       removeMulti = TRUE,
                       cells = c("T-AB"))

# read TRUST4 files
fl_TRUST4 <- list.files("../data/clono_TRUST4")
cl_TRUST4 <- lapply(fl_TRUST4, function(x){
  return(read.table(paste0("../data/clono_TRUST4/", x)))
})
names(cl_TRUST4) <- sub("_.*", "", fl_TRUST4)
head(cl_TRUST4[[1]])

combineTRUST4(cl_TRUST4)







library(immunarch)

immdata_10x <- repLoad("../data/clono_VDJ")
immdata_trust4 <- repLoad("../data/clono_TRUST4")
str(immdata_10x)


#plot_meta(gex,"umap_2",feat = "seurat_clusters")

# dir.create(paste0("../data/B_clono_VDJ"))
# for(i in sub("_.*","",file_list)){
#   dir.create(paste0("../data/B_clono_VDJ/",i))
#   system(paste0("cp ../data/clono_VDJ/",grep("_B_",grep(paste0(i,"_"),file_list,value = T),value = T)," ",paste0("../data/B_clono_VDJ/",i,"/") ))
# }

```


## read TRUST4 files

```{r}


```
