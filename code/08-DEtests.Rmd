---
output: html_document
editor_options: 
  chunk_output_type: console
---

# DE tests and Visualization {#DE-tests}
## Load packages

```{r}

source("./00_dependencies.R")

```


## Load data

```{r}

gex <- readRDS("../results/GEX7_BVDJ.rds")

```


## Check patient groups in Seurat object

```{r}

table(gex$patient_group, useNA = "always")
#Four non-overlapping groups
#1. SSAB - SSA+/SSB+
#2. SSA  - SSA+/SSB-
#3. DNEG - SSA-/SSB-
#4. CTRL - CTRL


```


#celltypesFine DE tests 
## pseudo bulk DE test between patient subgroups for celltypesFine

```{r}

#https://jef.works/blog/2020/04/06/quickly-creating-pseudobulks/

DGE_list <- list()
for (j in sort(unique(gex$cluster_cellType_manual_fine))){

  message(j)
  
  #subset gex to only contain subtype j
  gex.tmp <- gex %>% 
    DietSeurat(dimreducs = "umap_2") %>% 
    tidyseurat::filter(orig.ident != "P024", 
                       cluster_cellType_manual_fine == j)

  #create a model matrix for pseudo bulk generation
  mm <- model.matrix(~ 0 + orig.ident, 
                     data = gex.tmp@meta.data); head(mm); colnames(mm)
  
  #sample x number of cells per condition
  gex.tmp$subgroups <- factor(as.character(gex.tmp$orig.ident))
  sample_size <- table(gex.tmp$subgroups)
  sample_size[sample_size > 100] <- 100
  
  DGE_cells <- lapply(names(sample_size), function(x){ 
    set.seed(1)
    sample(colnames(gex.tmp) [gex.tmp$subgroups == x] , 
           size = sample_size[x], 
           replace = FALSE)
    })
  
  DGE_cells <- unlist(DGE_cells)
  mm <- mm[DGE_cells, ]
  
  #clean up colnames
  colnames(mm) <- gsub("orig.ident", "", colnames(mm))
  
  # create pseudo bulk count matrix
  gex.mm <- gex.tmp@assays$RNA@counts[, DGE_cells] %*% mm; dim(gex.mm)
  gex.mm <- gex.mm[rowSums(gex.mm) != 0, ]; dim(gex.mm)
  
  cellcounts <- colSums(mm); length(cellcounts)
  
  y <- DGEList(gex.mm, 
               sample = gsub("_.*", "", colnames(gex.mm)), 
               group = gsub(".*_", "", colnames(gex.mm)),
               remove.zeros = TRUE); y
  
  y$samples$patient_group <- as.factor(unique(gex.tmp@meta.data[, c("orig.ident", "patient_group")])$patient_group[match(y$samples$samples, unique(gex.tmp@meta.data[, c("orig.ident", "patient_group")])$orig.ident)])
  
  keep <- apply(y$counts, 1, function(x){sum(x >= 5) >= 3}); table(keep)
  y <- y[keep, ]
  y <- calcNormFactors(y)
  
  design <- model.matrix(~ patient_group, data = y$samples); colnames(design)
  colnames(design) <- gsub("patient_group", "", colnames(design))
  
  y_glm <- estimateDisp(y, design)
  fit <- glmQLFit(y_glm, design); colnames(fit$coefficients)
  
  #conserved differences across patient subgroups
  qlm <- glmQLFTest(fit, coef = 2:4)
  de_g <- topTags(qlm, n = nrow(y_glm$counts))$table; head(de_g, 25)
  
  de_g$celltypeFine <- j
  de_g$gene <- rownames(de_g)
  
  DGE_list[[j]] <- de_g
  
  saveRDS(fit, paste0("../results/DGEfit_patientGroups_celltypeFine_", j,".rds"))
  write.csv(de_g, paste0("../results/DGE_patientGroups_celltypeFine_", j,".csv"), row.names = TRUE)

}

saveRDS(DGE_list, "../results/DGE_B-cells_celltypeFine_patientGroups_listAll.rds")
#DGE_list <- readRDS("../results/DGE_B-cells_celltypeFine_patientGroups_listAll.rds")
lapply(DGE_list, function(x){head(x)})

DGE_list$DN4$celltypeFine <- "DN4"
DGE_list$Memory_Platelet$celltypeFine <- "Memory_Platelet"

names(DGE_list)

```


### filter rbind and export csv for all celltypeFine DE tests

```{r}

FDR_cutoff <- 0.25
DGE_list_out <- lapply(DGE_list, function(x){

  
  cat(unique(x$celltypeFine), "\n")
  
  #filter on FDR
  x <- x[x$FDR <= FDR_cutoff, ]
  
  cat(nrow(x), "\n")
  
  gex_tmp <- gex %>% 
    DietSeurat(dimreducs = "umap_2") %>% 
    tidyseurat::filter(cluster_cellType_manual_fine == unique(x$celltypeFine))
  
  #get "pct.exp" and "avg.exp" for filtering
  p <- DotPlot(gex_tmp, features = rownames(x), group.by = "patient_group")
  p <- p$data %>%  pivot_wider(names_from = "id", 
                          values_from = c("pct.exp", "avg.exp"), 
                          id_cols = "features.plot")
  x <- cbind(x, p)
  
  return(x)
  
})


DGE_list_out <- as.data.frame(do.call(rbind, DGE_list_out))

write.csv(DGE_list_out, paste0("../results/DGE_B-cells_celltypeFine_all_FDR", FDR_cutoff, ".csv"), row.names = FALSE)

```


### plot SFig5, filter and plot dotplots for top expressed genes celltypeFine, Supplementary Figure 5

```{r}

#filter DE genes
FDR_cutoff <- 0.2
FC_cutoff <- 2
PCTexpr_cutoff <- 20

####---- subset and make plots
DGE_list_p <- lapply(DGE_list, function(x) {
  
  a <- x
  
  print(unique(a$celltypeFine))
  
  #filter on FDR
  a <- a[a$FDR <= FDR_cutoff, ]
  
  cat("after FDR: ",nrow(a), "\n")
  
  gex_tmp <- gex %>% 
    DietSeurat(dimreducs = "umap_2") %>% 
    tidyseurat::filter(cluster_cellType_manual_fine == unique(a$celltypeFine))
  
  #get "pct.exp" and "avg.exp" for filtering
  p <- DotPlot(gex_tmp, features = rownames(a), group.by = "patient_group")
  p <- p$data %>%  pivot_wider(names_from = "id", 
                          values_from = c("pct.exp", "avg.exp"), 
                          id_cols = "features.plot")
  a <- cbind(a, p)
  
  #filter on fold change
  a <- a[apply(a[, 1:3], 1, max) > log2(FC_cutoff) |
         apply(a[, 1:3], 1, min) < log2(1/FC_cutoff), ]
  
  cat("after FC: ",nrow(a), "\n")
  
  #filter on percent expressed
  a <- a[apply(a[, 11:13], 1, max) > PCTexpr_cutoff, ]
  
  cat("after %e: ",nrow(a), "\n")

  return(a)
  
   }
  )


####---- plot dotplots to list
ngenes <- 20

plotlist <- c("DN1_ID3", "DN2", "DN2_CXCR3", "DN2_ITGAX", "DN4", "Memory_Cl", "Memory_IgM",
              "Memory_IgM_ALOX5", "Memory_IgM_CD1C", "Naive", "Naive_IFN", "Naive_Transitional")

p_list <- list()
for (i in sort(unique(plotlist))){

  cat(i,"\n")
  
  a <- as_tibble(DGE_list_p[[i]]) %>% arrange(DGE_list_p[[i]]) %>% pull(gene)
  
  cat(length(a),"\n")
  cat(a,"\n")
  
  if(length(a) < ngenes) {
    p_features <- a
  } else {
    p_features <- a[1:ngenes]
  }
  
  cat(length(p_features),"\n")
  
  #subset gex
  DGE_DATA <- gex %>% 
  DietSeurat(dimreducs = "umap_2") %>% 
  tidyseurat::filter(orig.ident != "P024", 
                       cluster_cellType_manual_fine == i)

  p_list[[i]] <- DotPlot(DGE_DATA, 
        features = p_features, 
        group.by = "patient_group",
        dot.scale = 4) +
  theme_classic() +
  xlab("") + 
  ylab("") + 
  ggtitle(i) +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1, 
                                   vjust = 0.5,
                                   size = 8),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        panel.grid.major = element_line(colour = "grey", size = rel(0.5)))

}

# ggsave2("../results/DGE_B-cells_celltypeFine_dotplots.png", 
#         plot_grid(plotlist = p_list, ncol = 4, labels = NULL, align = "h"), 
#         width = 28, height = 20, unit = "cm")

ggsave2("../results/SFig5.png", 
        plot_grid(plotlist = p_list, ncol = 3, labels = NULL, align = "hv"), 
        width = 26, height = 30, unit = "cm")


```


### plot SFig6 and SFig8, GSEA celltypesFine (GO_Biological_Process_2021 and MSigDB_Hallmark_2020)

```{r}

p_listH <- list()
p_listBP <- list()
gse_listH <- list()
gse_listBP <- list()

plotlist <- c("DN1_ID3", "DN2", "DN2_CXCR3", "DN2_ITGAX", "DN4", "Memory_Cl", "Memory_IgM",
              "Memory_IgM_ALOX5", "Memory_IgM_CD1C", "Naive", "Naive_IFN", "Naive_Transitional")

for (i in plotlist){
  
  go_cluster <- enrichr(genes = DGE_list[[i]]$gene[1:50], 
                        databases = c("GO_Biological_Process_2021", 
                                      "MSigDB_Hallmark_2020"))
  
  go_clusterBP <- go_cluster$GO_Biological_Process_2021
  go_clusterBP <- go_clusterBP[order(go_clusterBP$P.value), ]
  go_clusterBP$logP <- -log10(go_clusterBP$P.value)
  go_clusterBP$logPadj <- -log10(go_clusterBP$Adjusted.P.value)
  gse_listBP[[i]] <- go_clusterBP
  
  go_clusterH <- go_cluster$MSigDB_Hallmark_2020
  go_clusterH <- go_clusterH[order(go_clusterH$P.value), ]
  go_clusterH$logP <- -log10(go_clusterH$P.value)
  go_clusterH$logPadj <- -log10(go_clusterH$Adjusted.P.value)
  gse_listH[[i]] <- go_clusterH
  
  
  p_listH[[i]] <- ggplot(go_clusterH[1:6,], aes(x = reorder(Term, logP), 
                                              y = logPadj)) +
    geom_col(position = "dodge") +
    theme_classic() + 
    coord_flip() +
    theme(axis.text.x = element_text(angle = 0, 
                                     hjust = 0.5, 
                                     vjust = 0.5,
                                     size = 12,
                                     color = "black"),
          axis.text.y = element_text(angle = 0, 
                                     hjust = 1, 
                                     vjust = 0.5,
                                     size = 12,
                                     color = "black"),
          plot.title = element_text(hjust = 0),
          strip.background = element_blank(), 
          strip.text.y = element_blank(),
          legend.position = "none",
          plot.margin = unit(c(0.2,0.2,0.2,0.2), "cm")) +
      ylab(expression('-log10('~italic(P)~' adj)')) +
      xlab("") +
      scale_y_continuous(breaks = seq(0, 18, 3), limits = c(0, 18)) +
      ggtitle(paste0(i)) +
      geom_hline(aes(yintercept = 2), color = "black", linetype = "dashed")
  
  p_listBP[[i]] <- ggplot(go_clusterBP[1:20,], aes(x = reorder(Term, logP), 
                                              y = logPadj)) +
    geom_col(position = "dodge") +
    theme_classic() + 
    coord_flip() +
    theme(axis.text.x = element_text(angle = 0, 
                                     hjust = 0.5, 
                                     vjust = 0.5,
                                     size = 8,
                                     color = "black"),
          axis.text.y = element_text(angle = 0, 
                                     hjust = 1, 
                                     vjust = 0.5,
                                     size = 8,
                                     color = "black"),
          plot.title = element_text(hjust = 0),
          strip.background = element_blank(), 
          strip.text.y = element_blank(),
          legend.position = "none",
          plot.margin = unit(c(0.2,0.2,0.2,0.2), "cm")) +
      ylab(expression('-log10('~italic(P)~' adj)')) +
      xlab("") +
      scale_y_continuous(breaks = seq(0, 25, 5), limits = c(0, 25)) +
      ggtitle(paste0(i)) +
      geom_hline(aes(yintercept = 2), color = "black", linetype = "dashed")
  
}


write.csv(do.call(rbind.data.frame, gse_listH),
          "../results/DGE_B-cells_GSE_celltypeFine_hallmarks.csv", 
          row.names = FALSE)

write.csv(do.call(rbind.data.frame, gse_listBP),
          "../results/DGE_B-cells_GSE_celltypeFine_GOBP.csv", 
          row.names = FALSE)

ggsave2(paste0("../results/SFig6.png"),
          plot_grid(plotlist = p_listH, 
                    ncol = 3, 
                    labels = NULL, 
                    align = "vh" )  +
          bgcolor("white") + 
          border("white"),
          width = 35, height = 25, unit = "cm")

ggsave2(paste0("../results/SFig8.png"),
          plot_grid(plotlist = p_listBP, 
                    ncol = 3, 
                    labels = NULL, 
                    align = "vh" )  +
          bgcolor("white") + 
          border("white"),
          width = 58, height = 32, unit = "cm")

```


# celltypesMain DE tests 
## pseudo bulk DE test between patient subgroups for celltypesMain

```{r }

#https://jef.works/blog/2020/04/06/quickly-creating-pseudobulks/

DGE_list <- list()
for (j in sort(unique(gex$cluster_cellType_manual_main))){

  message(j)
  
  #subset gex to only contain subtype j
  gex.tmp <- gex %>% 
    DietSeurat(dimreducs = "umap_2") %>% 
    tidyseurat::filter(orig.ident != "P024", 
                       cluster_cellType_manual_main == j)

  #create a model matrix for pseudo bulk generation
  mm <- model.matrix(~ 0 + orig.ident, 
                     data = gex.tmp@meta.data); head(mm); colnames(mm)
  
  #sample x number of cells per condition
  gex.tmp$subgroups <- factor(as.character(gex.tmp$orig.ident))
  sample_size <- table(gex.tmp$subgroups)
  sample_size[sample_size > 100] <- 100
  
  DGE_cells <- lapply(names(sample_size), function(x){ 
    set.seed(1)
    sample(colnames(gex.tmp) [gex.tmp$subgroups == x] , 
           size = sample_size[x], 
           replace = FALSE)
    })
  
  DGE_cells <- unlist(DGE_cells)
  mm <- mm[DGE_cells, ]
  
  #clean up colnames
  colnames(mm) <- gsub("orig.ident", "", colnames(mm))
  
  # create pseudo bulk count matrix
  gex.mm <- gex.tmp@assays$RNA@counts[, DGE_cells] %*% mm; dim(gex.mm)
  gex.mm <- gex.mm[rowSums(gex.mm) != 0, ]; dim(gex.mm)
  
  cellcounts <- colSums(mm); length(cellcounts)
  
  y <- DGEList(gex.mm, 
               sample = gsub("_.*", "", colnames(gex.mm)), 
               group = gsub(".*_", "", colnames(gex.mm)),
               remove.zeros = TRUE); y
  
  y$samples$patient_group <- as.factor(unique(gex.tmp@meta.data[, c("orig.ident", "patient_group")])$patient_group[match(y$samples$samples, unique(gex.tmp@meta.data[, c("orig.ident", "patient_group")])$orig.ident)])
  
  keep <- apply(y$counts, 1, function(x){sum(x >= 5) >= 3}); table(keep)
  y <- y[keep, ]
  y <- calcNormFactors(y)
  
  design <- model.matrix(~ patient_group, data = y$samples); colnames(design)
  colnames(design) <- gsub("patient_group", "", colnames(design))
  
  y_glm <- estimateDisp(y, design)
  fit <- glmQLFit(y_glm, design); colnames(fit$coefficients)
  
  #conserved differences across patient subgroups
  qlm <- glmQLFTest(fit, coef = 2:4)
  de_g <- topTags(qlm, n = nrow(y_glm$counts))$table; head(de_g, 25)
  
  de_g$celltypeMain <- j
  de_g$gene <- rownames(de_g)
  
  DGE_list[[j]] <- de_g
  
  saveRDS(fit, paste0("../results/DGEfit_patientGroups_celltypeMain_", j,".rds"))
  write.csv(de_g, paste0("../results/DGE_patientGroups_celltypeMain_", j,".csv"), row.names = TRUE)

}

saveRDS(DGE_list, "../results/DGE_B-cells_celltypeMain_patientGroups_listAll.rds")
#DGE_list <- readRDS("../results/DGE_B-cells_celltypeMain_patientGroups_listAll.rds")


```


### filter rbind and export csv for all celltypesMain DE tests

```{r}

FDR_cutoff <- 0.25
DGE_list_out <- lapply(DGE_list, function(x){

  
  cat(unique(x$celltypeMain), "\n")
  
  #filter on FDR
  x <- x[x$FDR <= FDR_cutoff, ]
  
  cat(nrow(x), "\n")
  
  #subset GEX to only include cell type
  gex_tmp <- gex %>% 
    DietSeurat(dimreducs = "umap_2") %>% 
    tidyseurat::filter(cluster_cellType_manual_main == unique(x$celltypeMain))
  
  
  #get "pct.exp" and "avg.exp" for filtering
  p <- DotPlot(gex_tmp, features = rownames(x), group.by = "patient_group")
  p <- p$data %>%  pivot_wider(names_from = "id", 
                          values_from = c("pct.exp", "avg.exp"), 
                          id_cols = "features.plot")
  x <- cbind(x, p)
  
  return(x)
  
})

DGE_list_out <- as.data.frame(do.call(rbind, DGE_list_out))

write.csv(DGE_list_out, paste0("../results/DGE_B-cells_celltypeMain_all_FDR", FDR_cutoff, ".csv"), row.names = FALSE)

```


### plot Fig2A, filter and plot dotplots for top expressed genes for celltypesMain

```{r}

#filter DE genes
FDR_cutoff <- 0.2
FC_cutoff <- 2
PCTexpr_cutoff <- 20

####---- subset and make plots
DGE_list_p <- lapply(DGE_list, function(x) {
  
  a <- x
  
  print(unique(a$celltypeMain))
  
  #filter on FDR
  a <- a[a$FDR <= FDR_cutoff, ]
  
  cat("after FDR: ",nrow(a), "\n")
  
  #subset GEX to only include cell type
  gex_tmp <- gex %>% 
    DietSeurat(dimreducs = "umap_2") %>% 
    tidyseurat::filter(cluster_cellType_manual_main == unique(a$celltypeMain))
  
  cat("nrow GEX: ", nrow(gex_tmp@meta.data), "\n")
  
  #get "pct.exp" and "avg.exp" for filtering
  p <- DotPlot(gex_tmp, features = rownames(a), group.by = "patient_group")
  p <- p$data %>%  pivot_wider(names_from = "id", 
                               values_from = c("pct.exp", "avg.exp"), 
                               id_cols = "features.plot")
  a <- cbind(a, p)
  
  #filter on fold change
  a <- a[apply(a[, 1:3], 1, max) > log2(FC_cutoff) |
         apply(a[, 1:3], 1, min) < log2(1/FC_cutoff), ]
  
  cat("after FC: ",nrow(a), "\n")
  
  #filter on percent expressed
  a <- a[apply(a[, 11:13], 1, max) > PCTexpr_cutoff, ]
  
  cat("after %e: ",nrow(a), "\n")

  return(a)
  
   }
  )


####---- plot dotplots to list
ngenes <- 25

p_list <- list()
for (i in sort(unique(gex$cluster_cellType_manual_main))[-c(3, 4, 6)]){

  cat(i,"\n")
  
  a <- as_tibble(DGE_list_p[[i]]) %>% arrange(PValue) %>% pull(gene)
  
  cat(length(a),"\n")
  cat(a,"\n")
  
  if(length(a) < ngenes) {
    p_features <- a
  } else {
    p_features <- a[1:ngenes]
  }
  
  cat(length(p_features),"\n")
  
  #subset gex
  DGE_DATA <- gex %>% 
  DietSeurat(dimreducs = "umap_2") %>% 
  tidyseurat::filter(orig.ident != "P024", 
                     cluster_cellType_manual_main == i,
                     )

  p_list[[i]] <- DotPlot(DGE_DATA, 
        features = p_features, 
        group.by = "patient_group",
        dot.scale = 4) +
  theme_classic() +
  xlab("") + 
  ylab("") + 
  ggtitle(i) +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1, 
                                   vjust = 0.5,
                                   size = 8),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5,
                                  size = 10),
        panel.grid.major = element_line(colour = "grey", size = rel(0.5)))

}

ggsave2("../results/DGE_B-cells_celltypeMain_dotplots_2.png", 
        plot_grid(plotlist = p_list, ncol = 4, labels = NULL, align = "h"), 
        width = 25, height = 10, unit = "cm")

ggsave2("../results/DGE_B-cells_celltypeMain_mutstat_dotplots_2.png", 
        plot_grid(plotlist = p_list, ncol = 4, labels = NULL, align = "h"), 
        width = 25, height = 10, unit = "cm")


```


### plot FIG2B and SFig7, GSEA celltypesMain (GO_Biological_Process_2021 and MSigDB_Hallmark_2020)

```{r}

p_listH <- list()
p_listBP <- list()
gse_listH <- list()
gse_listBP <- list()

for (i in sort(names(DGE_list))[-c(3, 4, 6)]){
  
  go_cluster <- enrichr(genes = DGE_list[[i]]$gene[1:50], 
                        databases = c("GO_Biological_Process_2021", 
                                      "MSigDB_Hallmark_2020"))
  
  go_clusterBP <- go_cluster$GO_Biological_Process_2021
  go_clusterBP <- go_clusterBP[order(go_clusterBP$P.value), ]
  go_clusterBP$logP <- -log10(go_clusterBP$P.value)
  go_clusterBP$logPadj <- -log10(go_clusterBP$Adjusted.P.value)
  gse_listBP[[i]] <- go_clusterBP
  
  go_clusterH <- go_cluster$MSigDB_Hallmark_2020
  go_clusterH <- go_clusterH[order(go_clusterH$P.value), ]
  go_clusterH$logP <- -log10(go_clusterH$P.value)
  go_clusterH$logPadj <- -log10(go_clusterH$Adjusted.P.value)
  gse_listH[[i]] <- go_clusterH
  
  p_listH[[i]] <- ggplot(go_clusterH[1:6,], 
                         aes(x = reorder(Term, logP), 
                             y = logPadj)) +
    geom_col(position = "dodge") +
    theme_classic() + 
    coord_flip() +
    theme(axis.text.x = element_text(angle = 0, 
                                     hjust = 0.5, 
                                     vjust = 0.5,
                                     size = 12,
                                     color = "black"),
          axis.text.y = element_text(angle = 0, 
                                     hjust = 1, 
                                     vjust = 0.5,
                                     size = 12,
                                     color = "black"),
          #scale_y_continuous(breaks = seq(0, 25, 5), limits = c(0, 25)) +
          strip.background = element_blank(), 
          strip.text.y = element_blank(),
          legend.position = "none",
          plot.margin = unit(c(0.2,0.2,0.2,0.2), "cm")) +
      ylab(expression('-log10('~italic(P)~' adj)')) +
      xlab("") +
      #scale_x_continuous(breaks = seq(0, 15, 5), limits = c(0, 15)) +
      ggtitle(paste0(i)) +
      geom_hline(aes(yintercept = 2), color = "black", linetype = "dashed")
  
  p_listBP[[i]] <- ggplot(go_clusterBP[1:20,], 
                          aes(x = reorder(Term, logP), 
                              y = logPadj)) +
    geom_col(position = "dodge") +
    theme_classic() + 
    coord_flip() +
    theme(axis.text.x = element_text(angle = 0, 
                                     hjust = 0.5, 
                                     vjust = 0.5,
                                     size = 12,
                                     color = "black"),
          axis.text.y = element_text(angle = 0, 
                                     hjust = 1, 
                                     vjust = 0.5,
                                     size = 12,
                                     color = "black"),
          scale_y_continuous(breaks = seq(0, 20, 5), limits = c(0, 20)) +
          strip.background = element_blank(), 
          strip.text.y = element_blank(),
          legend.position = "none",
          plot.margin = unit(c(0.2,0.2,0.2,0.2), "cm")) +
      ylab(expression('-log10('~italic(P)~' adj)')) +
      xlab("") +
      ggtitle(paste0(i)) +
      geom_hline(aes(yintercept = 2), color = "black", linetype = "dashed")
  
}

write.csv(do.call(rbind.data.frame, gse_listH),
          "../results/DGE_B-cells_GSE_celltypeMain_hallmarks.csv", 
          row.names = FALSE)

write.csv(do.call(rbind.data.frame, gse_listBP),
          "../results/DGE_B-cells_GSE_celltypeMain_GOBP.csv", 
          row.names = FALSE)

ggsave2(paste0("../results/DGE_B-cells_GSE_celltypeMain_hallmarks.png"),
          plot_grid(plotlist = p_listH, 
                    ncol = 4, 
                    labels = NULL, 
                    align = "vh" ) + bgcolor("white"),
          width = 40, height = 8, unit = "cm")

ggsave2(paste0("../results/DGE_B-cells_GSE_celltypeMain_GOBP.png"),
          plot_grid(plotlist = p_listBP, 
                    ncol = 4, 
                    labels = NULL, 
                    align = "vh" ) + bgcolor("white"),
          width = 90, height = 8, unit = "cm")


```


# DE tests celltypesMain mu status
## vizualize cutoff and add categorical variable for mutation status

```{r }

gex@meta.data %>% 
  filter(!is.na(mu_freq_total)) %>%
  group_by(orig.ident, cluster_cellType_manual_main) %>%
  filter(cluster_cellType_manual_main == 'DN' | 
           cluster_cellType_manual_main == 'Memory') %>%
  summarise(mean = mean(mu_freq_total), n = n()) %>%
ggplot(aes(x = orig.ident,
             y = mean,
           color = cluster_cellType_manual_main)) +
  geom_point() + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, 
                                     hjust = 0.5, 
                                     vjust = 0.5,
                                     size = 10,
                                     color = "black")) +
  geom_hline(aes(yintercept = 0.02), color = "black", linetype = "dashed")

mut_stat$mut <- ifelse(mut_stat$mean < 0.025, "unmutated", "mutated")


mut_stat <- gex@meta.data %>% 
  filter(!is.na(mu_freq_total)) %>%
  filter(cluster_cellType_manual_main == 'DN' | 
           cluster_cellType_manual_main == 'Memory') %>%
  group_by(orig.ident) %>%
  summarise(mean = mean(mu_freq_total), n = n())

mut_stat2 <- gex@meta.data %>% 
  filter(!is.na(mu_freq_total)) %>%
  group_by(orig.ident, cluster_cellType_manual_main) %>%
  filter(cluster_cellType_manual_main == 'DN' | 
           cluster_cellType_manual_main == 'Memory' |
           cluster_cellType_manual_main == 'Naive' |
           cluster_cellType_manual_main == 'Transitional') %>%
  summarise(mean = mean(mu_freq_total), n = n()) %>% 
  pivot_wider(names_from = cluster_cellType_manual_main, values_from = mean,id_cols = orig.ident) %>%
  mutate(mut = case_when(DN <= 0.02 ~ "Unmutated", 
                           Memory <= 0.02 ~ "Unmutated", 
                           TRUE ~ "Mutated"))

colnames(gex@meta.data)
gex@meta.data$mut_stat <- mut_stat2$mut[match(gex@meta.data$orig.ident, mut_stat2$orig.ident)]

tmp <- unique(gex@meta.data[, c("patient_group", "mut_stat", "orig.ident")])  
table(tmp$patient_group,tmp$mut_stat)
  #      Mutated Unmutated
  # CTRL       4         0
  # DNEG       6         0
  # SSA        7         1
  # SSAB       3         6

tmp <- gex@meta.data %>% filter(orig.ident != "P024",
                                patient_group == "SSAB")

gex.tmp <- gex %>% 
    DietSeurat(dimreducs = "umap_2") %>% 
    tidyseurat::filter(orig.ident != "P024", 
                       patient_group == "SSAB")

gex.tmp <- SetIdent(gex.tmp, value = "c_call")

p1 <- DimPlot(gex.tmp, 
              reduction = "umap_2", 
              #group.by = "mut_stat",
              split.by = "mut_stat",
              pt.size = 0.1) + 
  xlab("UMAP 1") + 
  ylab("UMAP 2") + 
  ggtitle("celltypes main") + 
    theme(axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom")

ig.features <- c("IGHA1", "IGHA2", "IGHG1", "IGHG2", "IGHG3", "IGHG4",  "IGHD", "IGHE", "IGHM")

p <- list()
for (i in ig.features) {
  
  p[[i]] <- FeaturePlot(gex, 
                        reduction = "umap_2", 
                        features = i,
                        pt.size = 0.2,
                        order = TRUE,
                        cols = c("lightgray", "blue", "navy")) + 
    #xlab("") + 
    #ylab("") + 
    theme_void() +
    #theme_classic() +
    theme(legend.position = "none",
          #axis.text = element_blank(),
          #axis.ticks = element_blank(),
          #axis.title = element_blank(),
          plot.title = element_text(hjust = 0.5, vjust = 0),
          plot.margin = unit(c(0, 0, 0, 0), "cm")) + 
    NoLegend()
  
}

p2 <- plot_grid(plotlist = p, ncol = 3, align = "hv", scale = 1.1) 

ggsave2(paste0("../results/Fig1C.png"), 
        plot_grid(p1, p2, ncol = 2, rel_widths = c(1.1, 1)) + bgcolor("white"), 
        width = 30, height = 15, unit = "cm")


as.data.frame.matrix(table(tmp[, c("mu_load", "c_call","cluster_cellType_manual_fine")]))


table(tmp[, c("mu_load", "c_call", "cluster_cellType_manual_fine")])
table(tmp[, c("mu_load", "c_call","mut_stat")])

tmp <- as.data.frame.matrix(table(tmp[, c("cluster_cellType_manual_fine", "mut_stat")]))

tmp <- mutate(tmp, 
              muFrac=Mutated/sum(Mutated)*100,
              unFrac=Unmutated/sum(Unmutated)*100)



```


## pseudo bulk DE test between patients with different VDJ mu status for celltypesMain

```{r }

DGE_list <- list()
for (j in sort(unique(gex$cluster_cellType_manual_main))[-6]){

  message(j)
  
  #subset gex to only contain subtype j
  # gex.tmp <- gex %>%
  #   DietSeurat(dimreducs = "umap_2") %>%
  #   tidyseurat::filter(orig.ident != "P024",
  #                      cluster_cellType_manual_main == j,
  #                      patient_group == "SSA" |
  #                        patient_group == "SSAB")
  
  gex.tmp <- gex %>%
    DietSeurat(dimreducs = "umap_2") %>%
    tidyseurat::filter(orig.ident != "P024",
                       cluster_cellType_manual_main == j,
                       patient_group == "SSAB")

  print(table(gex.tmp@meta.data$patient_group))
  
  #create a model matrix for pseudo bulk generation
  mm <- model.matrix(~ 0 + orig.ident,
                     data = gex.tmp@meta.data); head(mm); colnames(mm)

  #sample x number of cells per condition
  gex.tmp$subgroups <- factor(as.character(gex.tmp$orig.ident))
  sample_size <- table(gex.tmp$subgroups)
  sample_size[sample_size > 100] <- 100

  DGE_cells <- lapply(names(sample_size), function(x){
    set.seed(1)
    sample(colnames(gex.tmp)[gex.tmp$subgroups == x] ,
           size = sample_size[x],
           replace = FALSE)
    })

  DGE_cells <- unlist(DGE_cells)
  mm <- mm[DGE_cells, ]

  #clean up colnames
  colnames(mm) <- gsub("orig.ident", "", colnames(mm))

  # create pseudo bulk count matrix
  gex.mm <- gex.tmp@assays$RNA@counts[, DGE_cells] %*% mm
  gex.mm <- gex.mm[rowSums(gex.mm) != 0, ]

  cellcounts <- colSums(mm)

  y <- DGEList(gex.mm,
               sample = gsub("_.*", "", colnames(gex.mm)),
               group = gsub(".*_", "", colnames(gex.mm)),
               remove.zeros = TRUE); y
   
  y$samples$mut_stat <- as.factor(unique(gex.tmp@meta.data[, c("orig.ident", "mut_stat")])$mut_stat[match(y$samples$samples, unique(gex.tmp@meta.data[, c("orig.ident", "mut_stat")])$orig.ident)])

  keep <- apply(y$counts, 1, function(x){sum(x >= 5) >= 3}); table(keep)
  y <- y[keep, ]
  y <- calcNormFactors(y)

  design <- model.matrix(~mut_stat, data = y$samples); colnames(design)
  colnames(design) <- gsub("patient_group", "", colnames(design))

  y_glm <- estimateDisp(y, design)
  fit <- glmQLFit(y_glm, design); print(colnames(fit$coefficients))

  #conserved differences between differentially mutated groups
  qlm <- glmQLFTest(fit, coef = 2)
  de_g <- topTags(qlm, n = nrow(y_glm$counts))$table; head(de_g, 25)

  de_g$celltypeMain <- j
  de_g$gene <- rownames(de_g)

  DGE_list[[j]] <- de_g

  # #saveRDS(fit, paste0("../results/DGEfit_patientGroups_celltypeMain_", j,".rds"))
  # #write.csv(de_g, paste0("../results/DGE_patientGroups_celltypeMain_", j,".csv"), row.names = TRUE)

}

saveRDS(DGE_list, "../results/DGE_B-cells_celltypeMain_mutationStatus_listAll_SSAB.rds")
#DGE_list <- readRDS("../results/DGE_B-cells_celltypeMain_patientGroups_listAll.rds")

#head(DGE_list[[1]], n = 50)

for (i in names(DGE_list)){
  
  print(i)
  print(nrow(DGE_list[[i]]))
  print(nrow(DGE_list[[i]][DGE_list[[i]]$FDR < 0.1, ]))
  print(head(DGE_list[[i]], n = 10))
  
}



```


## subset and plot mut_stat DE genes celltypeMain
### filter and plot dotplots for top expressed genes for celltypesMain

```{r}

#filter DE genes
FDR_cutoff <- 0.25
FC_cutoff <- 1.5
PCTexpr_cutoff <- 10

####---- subset and make plots
DGE_list_p <- lapply(DGE_list, function(x) {
  
  a <- x
  
  print(unique(a$celltypeMain))
  
  #filter on FDR
  a <- a[a$FDR <= FDR_cutoff, ]
  
  cat("after FDR: ",nrow(a), "\n")
  
  #subset GEX to only include cell type
  gex_tmp <- gex %>% 
    DietSeurat(dimreducs = "umap_2") %>% 
    tidyseurat::filter(cluster_cellType_manual_main == unique(a$celltypeMain))
  
  cat("nrow GEX: ", nrow(gex_tmp@meta.data), "\n")
  
  #get "pct.exp" and "avg.exp" for filtering
  p <- DotPlot(gex_tmp, features = rownames(a), group.by = "patient_group")
  p <- p$data %>%  pivot_wider(names_from = "id", 
                               values_from = c("pct.exp", "avg.exp"), 
                               id_cols = "features.plot")
  a <- cbind(a, p)
  
  #filter on fold change
  a <- a[apply(a[, 1:3], 1, max) > log2(FC_cutoff) |
         apply(a[, 1:3], 1, min) < log2(1/FC_cutoff), ]
  
  cat("after FC: ",nrow(a), "\n")
  
  #filter on percent expressed
  a <- a[apply(a[, 11:13], 1, max) > PCTexpr_cutoff, ]
  
  cat("after %e: ",nrow(a), "\n")

  return(a)
  
   }
  )


####---- plot dotplots to list
ngenes <- 25

p_list <- list()
for (i in sort(unique(gex$cluster_cellType_manual_main))[-c(3, 4, 6)]){

  cat(i,"\n")
  
  a <- as_tibble(DGE_list[[i]]) %>% filter(FDR < 0.25) %>% arrange(PValue) %>% pull(gene)
  
  cat(length(a),"\n")
  cat(a,"\n")
  
  if(length(a) < ngenes) {
    p_features <- a
  } else {
    p_features <- a[1:ngenes]
  }
  
  cat(length(p_features),"\n")
  
  #subset gex
  DGE_DATA <- gex %>% 
  DietSeurat(dimreducs = "umap_2") %>% 
  tidyseurat::filter(orig.ident != "P024", 
                     cluster_cellType_manual_main == i,
                     patient_group == "SSAB")

  p_list[[i]] <- DotPlot(DGE_DATA, 
        features = p_features, 
        group.by = "mut_stat",
        dot.scale = 4) +
  theme_classic() +
  xlab("") + 
  ylab("") + 
  ggtitle(i) +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1, 
                                   vjust = 0.5,
                                   size = 8),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5,
                                  size = 10),
        panel.grid.major = element_line(colour = "grey", size = rel(0.5)))

}

ggsave2("../results/DGE_B-cells_celltypeMain_mutstat_dotplots_2.png", 
        plot_grid(plotlist = p_list, ncol = 4, labels = NULL, align = "h"), 
        width = 25, height = 10, unit = "cm")


```


## pseudo bulk DE test between patients with different VDJ mu status for celltypesFine

```{r }

DGE_list <- list()
for (j in sort(unique(gex$cluster_cellType_manual_fine))[-16]){

  message(j)
  
  #subset gex to only contain subtype j
  # gex.tmp <- gex %>% 
  #   DietSeurat(dimreducs = "umap_2") %>% 
  #   tidyseurat::filter(orig.ident != "P024", 
  #                      cluster_cellType_manual_fine == j,
  #                      patient_group == "SSA" | 
  #                        patient_group == "SSAB")
    gex.tmp <- gex %>% 
    DietSeurat(dimreducs = "umap_2") %>% 
    tidyseurat::filter(orig.ident != "P024", 
                       cluster_cellType_manual_fine == j,
                         patient_group == "SSAB")

  print(table(gex.tmp@meta.data$patient_group))
  
  #create a model matrix for pseudo bulk generation
  mm <- model.matrix(~ 0 + orig.ident,
                     data = gex.tmp@meta.data); head(mm); colnames(mm)

  #sample x number of cells per condition
  gex.tmp$subgroups <- factor(as.character(gex.tmp$orig.ident))
  sample_size <- table(gex.tmp$subgroups)
  sample_size[sample_size > 100] <- 100

  DGE_cells <- lapply(names(sample_size), function(x){
    set.seed(1)
    sample(colnames(gex.tmp)[gex.tmp$subgroups == x] ,
           size = sample_size[x],
           replace = FALSE)
    })

  DGE_cells <- unlist(DGE_cells)
  mm <- mm[DGE_cells, ]

  #clean up colnames
  colnames(mm) <- gsub("orig.ident", "", colnames(mm))

  # create pseudo bulk count matrix
  gex.mm <- gex.tmp@assays$RNA@counts[, DGE_cells] %*% mm; dim(gex.mm)
  gex.mm <- gex.mm[rowSums(gex.mm) != 0, ]; dim(gex.mm)

  cellcounts <- colSums(mm)
  
  #remove BCR genes
  gex.mm <- gex.mm[!grepl("^IGH", rownames(gex.mm)), ]; dim(gex.mm)
  gex.mm <- gex.mm[!grepl("^IGK", rownames(gex.mm)), ]; dim(gex.mm)
  gex.mm <- gex.mm[!grepl("^IGL", rownames(gex.mm)), ]; dim(gex.mm)
  
  y <- DGEList(gex.mm,
               sample = gsub("_.*", "", colnames(gex.mm)),
               group = gsub(".*_", "", colnames(gex.mm)),
               remove.zeros = TRUE); y
   
  y$samples$mut_stat <- as.factor(unique(gex.tmp@meta.data[, c("orig.ident", "mut_stat")])$mut_stat[match(y$samples$samples, unique(gex.tmp@meta.data[, c("orig.ident", "mut_stat")])$orig.ident)])

  keep <- apply(y$counts, 1, function(x){sum(x >= 5) >= 3}); table(keep)
  y <- y[keep, ]
  y <- calcNormFactors(y)

  design <- model.matrix(~mut_stat, data = y$samples); colnames(design)
  colnames(design) <- gsub("patient_group", "", colnames(design))

  y_glm <- estimateDisp(y, design)
  fit <- glmQLFit(y_glm, design); colnames(fit$coefficients)

  #conserved differences between differentially mutated groups
  qlm <- glmQLFTest(fit, coef = 2)
  de_g <- topTags(qlm, n = nrow(y_glm$counts))$table; head(de_g, 25)

  de_g$celltypeMain <- j
  de_g$gene <- rownames(de_g)

  DGE_list[[j]] <- de_g

  # #saveRDS(fit, paste0("../results/DGEfit_patientGroups_celltypeMain_", j,".rds"))
  # #write.csv(de_g, paste0("../results/DGE_patientGroups_celltypeMain_", j,".csv"), row.names = TRUE)

}

saveRDS(DGE_list, "../results/DGE_B-cells_celltypeFine_mutationStatus_listAll_SSAB.rds")
#DGE_list <- readRDS("../results/DGE_B-cells_celltypeMain_patientGroups_listAll.rds")

for (i in names(DGE_list)){
  print(i)
  print(nrow(DGE_list[[i]]))
  print(nrow(DGE_list[[i]][DGE_list[[i]]$FDR < 0.1, ]))
  print(head(DGE_list[[i]], n = 10))
}



```


## subset and plot mut_stat DE genes celltypeFine




### violin plot for select DE features

```{r}
tmp <- Seurat::Read10X_h5("/Users/gusarv/Downloads/TS_Trachea.h5ad")

remotes::install_github("theislab/zellkonverter")
install.packages("zellkonverter")
library(zellkonverter)

DE_features_ifn <- c("EIF2AK2", "IFI44L", "IFITM1", "STAT1")

DE_features_2 <- c("LTB", "MX1", "CXCR4", "IL4R")

gex_p <- gex %>% 
  DietSeurat(dimreducs = "umap_2") %>% 
  tidyseurat::filter(cluster_cellType_manual_main != "Plasma_cell",
                     cluster_cellType_manual_main != "Memory_Platlet",
                     cluster_cellType_manual_main != "Memory_stressed")

p2 <- VlnPlot(gex %>% 
  DietSeurat(dimreducs = "umap_2") %>% 
  tidyseurat::filter(cluster_cellType_manual_main != "Plasma_cell",
                     cluster_cellType_manual_main != "Memory_Platlet",
                     cluster_cellType_manual_main != "Memory_stressed"), 
              features = DE_features_ifn, 
              group.by = "cluster_cellType_manual_main",
              split.by = "patient_group",
              #split.plot = TRUE,
              slot = "data", 
              log = FALSE, 
              ncol = 4)
ggsave2("../results/VlnPlot_markers_b_features_3.png", 
        p2, 
        width = 20, height = 10, unit = "cm")



```


### dotplots for top 50 differentially expressed genes celltypeFine 

```{r}

# for (i in unique(gex$cluster_cellType_manual_fine)){
# 
# message(i)
#   
# #get top expressed genes
# tmp <- DGE_list[[i]]
# tmp <- head(tmp, n = 50)
# 
# #subset seurat object
# DGE_DATA <- gex %>% 
#   DietSeurat(dimreducs = "umap_2") %>% 
#   tidyseurat::filter(orig.ident != "P024", 
#                        cluster_cellType_manual_fine == i)
# 
# DGE_DATA$patient_group <- factor(DGE_DATA$patient_group, levels = sort(unique(DGE_DATA$patient_group)))
# DGE_DATA$group <- paste0(DGE_DATA$cluster_cellType_manual_fine,
#                                 "__",
#                                 DGE_DATA$patient_group)
# DGE_DATA$group <- factor(DGE_DATA$group, levels = sort(unique(DGE_DATA$group)))
# 
# # detable$groups <- paste0(detable$cell_cluster, detable$cluster)
# # detable %>% group_by(groups)  %>% top_n(-60, p_val) %>% top_n(40, pct.diff) %>% top_n(20, log.pct.diff) -> top
# 
# ord <- factor(sapply(unique(as.character(tmp$gene)), 
#                      function(x) {getcluster(DGE_DATA, x, "group")}))
# ord
# 
# pdf(paste0("../results/DGE_B-cells_perPatientGroup_",i,".pdf"), 
#     width = 8, 
#     height = length(ord) / 5 + 2)
# mypar(1, 1, mar = c(10, 6, 1, 5))
# plot_dots(DGE_DATA, 
#           unique(as.character(tmp$gene))[order(as.numeric(as.character(ord)))], 
#           clustering = "group", 
#           show_grid = T,
#           main = paste0("top cluster markers; ", i),
#           cex.main = 1, 
#           font.main = 1, 
#           cex.col = 1, 
#           srt = 90, 
#           cex.row = 1.1)
# #abline(v = cumsum(c(table(sub("__.*", "", names(table(DGE_DATA$group)))))) + 0.5)
# dev.off()
# }
# 
# gex$celltype_fine_patient_group <- paste0(gex$cluster_cellType_manual_fine, gex$patient_group)
# tmp <- lapply(DGE_list, function(x){head(x, n = 10)})
# tmp <- do.call("rbind", tmp)
  
# DotPlot(gex, features = tmp$gene, group.by = "celltype_fine_patient_group", split.by = "patient_group") + RotatedAxis()

```



## plot expression for GWAS genes PMID: 34112769 https://pubmed-ncbi-nlm-nih-gov.ezproxy.its.uu.se/34112769/

```{r }

gwas_genes <- read.csv("/Users/gusarv/Desktop/pSS_GWASgenes_PMID34112769.txt", header = FALSE)
gwas_genes <- unique(gwas_genes$V1)
gwas_genes <- gwas_genes[!(gwas_genes %in% c("C6orf10", "HCG27", "LINC02571", "MSH5-SAPCD1", "LINC02571"))]

p <- VlnPlot(gex, gwas_genes, group.by = "cluster_cellType_manual_main", split.by = "patient_group")

ggsave2("../results/VlnPlot_gwas_2.png", 
        p, 
        width = 40, height = 60, unit = "cm")

p <- VlnPlot(gex, "FCRL4", group.by = "cluster_cellType_manual_fine", split.by = "patient_group")
dev.off()

pheatmap(prop.table(as.matrix(as.data.frame.matrix(table(gex$patient_group, gex$cluster_size_airr))), 1 ))
prop.table(as.matrix(as.data.frame.matrix(table(gex$patient_group, gex$cluster_size_airr))), 1 )

```


## plot expression for previously identified marker genes

```{r }

genelist <- c("",)

p <- VlnPlot(gex, gwas_genes, group.by = "cluster_cellType_manual_main", split.by = "patient_group")

ggsave2("../results/VlnPlot_gwas_2.png", 
        p, 
        width = 40, height = 60, unit = "cm")

p <- VlnPlot(gex, "FCRL4", group.by = "cluster_cellType_manual_fine", split.by = "patient_group")
dev.off()

pheatmap(prop.table(as.matrix(as.data.frame.matrix(table(gex$patient_group, gex$cluster_size_airr))), 1 ))
prop.table(as.matrix(as.data.frame.matrix(table(gex$patient_group, gex$cluster_size_airr))), 1 )

```


## intersects between B-cell clusters

```{r }

DGE <- read.csv("/Users/gusarv/Documents/projekt/SjS/data/pss_bcells_scRNAseq/results/DGE_B-cells_celltypeMain_all_FDR0.25.csv", header = TRUE, stringsAsFactors = FALSE)

head(DGE)

i1 <- intersect(DGE$gene[DGE$celltypeMain=="DN"], DGE$gene[DGE$celltypeMain=="Memory"])
i2 <- intersect(DGE$gene[DGE$celltypeMain=="Naive"], DGE$gene[DGE$celltypeMain=="Transitional"])

i3 <- intersect(i1, i2)

DGE$gene[DGE$celltypeMain=="DN"]
DGE$gene[DGE$celltypeMain=="Memory"]
DGE$gene[DGE$celltypeMain=="Naive"]
DGE$gene[DGE$celltypeMain=="Transitional"]
table(DGE$celltypeMain)



```

## DE between VH mutation classes for memory B-cells

```{r }

/Users/gusarv/Documents/projekt/SjS/data/pss_bcells_scRNAseq/results/DGE_B-cells_celltypeMain_all_FDR0.25.csv

```


## Save rds 

```{r}

#saveRDS(gex, file = "../results/xxx.rds")

```


## Print sessionInfo()

```{r}

sessionInfo()

```



