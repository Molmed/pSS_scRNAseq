---
output: html_document
editor_options: 
  chunk_output_type: console
---

# DE tests and Visualization {#DE-tests}
## Load packages

```{r}

source("./00_dependencies.R")

```


## Load data

```{r}

gex <- readRDS("../results/GEX7_BVDJ.rds")

```


## Add patient groups to Seurat object

```{r}

# gex$patient_group <- paste0(ifelse(gex$SSA == "YES", "SSA", ""), 
#                             "_", 
#                             ifelse(gex$SSB == "YES", "SSB", ""))
# pat_annot <- c(SSAB = "SSA_SSB", SSA = "SSA_", DNEG="NA_NA", DNEG="_")
# gex$patient_group <- names(pat_annot)[match(gex$patient_group, pat_annot)]
# gex$patient_group[grep("^C00", gex$orig.ident) ] <- "CTRL"

table(gex$patient_group, useNA = "ifany")
#Four non-overlapping groups
#1. SSAB - SSA+/SSB+
#2. SSA  - SSA+/SSB-
#3. DNEG - SSA-/SSB-
#4. CTRL - CTRL


```


#DE tests
## pseudo bulk DE test between patient subgroups for celltypesFine

```{r }

#https://jef.works/blog/2020/04/06/quickly-creating-pseudobulks/

DGE_list <- list()
for (j in unique(gex$cluster_cellType_manual_fine)){

  message(j)
  
  #subset gex to only contain subtype j
  gex.tmp <- gex %>% 
    DietSeurat(dimreducs = "umap_2") %>% 
    tidyseurat::filter(orig.ident != "P024", 
                       cluster_cellType_manual_fine == j)

  #create a model matrix for pseudo bulk generation
  mm <- model.matrix(~ 0 + orig.ident, 
                     data = gex.tmp@meta.data); head(mm); colnames(mm)
  
  #sample x number of cells per condition
  gex.tmp$subgroups <- factor(as.character(gex.tmp$orig.ident))
  sample_size <- table(gex.tmp$subgroups)
  sample_size[sample_size > 100] <- 100
  
  DGE_cells <- lapply(names(sample_size), function(x){ 
    set.seed(1)
    sample(colnames(gex.tmp) [gex.tmp$subgroups == x] , 
           size = sample_size[x], 
           replace = FALSE)
    })
  
  DGE_cells <- unlist(DGE_cells)
  mm <- mm[DGE_cells, ]
  
  #clean up colnames
  colnames(mm) <- gsub("orig.ident", "", colnames(mm))
  
  # create pseudo bulk count matrix
  gex.mm <- gex.tmp@assays$RNA@counts[, DGE_cells] %*% mm; dim(gex.mm)
  gex.mm <- gex.mm[rowSums(gex.mm) != 0, ]; dim(gex.mm)
  
  cellcounts <- colSums(mm); length(cellcounts)
  
  y <- DGEList(gex.mm, 
               sample = gsub("_.*", "", colnames(gex.mm)), 
               group = gsub(".*_", "", colnames(gex.mm)),
               remove.zeros = TRUE); y
  
  y$samples$patient_group <- as.factor(unique(gex.tmp@meta.data[, c("orig.ident", "patient_group")])$patient_group[match(y$samples$samples, unique(gex.tmp@meta.data[, c("orig.ident", "patient_group")])$orig.ident)])
  
  keep <- apply(y$counts, 1, function(x){sum(x >= 5) >= 3}); table(keep)
  y <- y[keep, ]
  y <- calcNormFactors(y)
  
  design <- model.matrix(~ patient_group, data = y$samples); colnames(design)
  colnames(design) <- gsub("patient_group", "", colnames(design))
  
  y_glm <- estimateDisp(y, design)
  fit <- glmQLFit(y_glm, design); colnames(fit$coefficients)
  
  #conserved differences across patient subgroups
  qlm <- glmQLFTest(fit, coef = 2:4)
  de_g <- topTags(qlm, n = nrow(y_glm$counts))$table; head(de_g, 25)
  
  de_g$celltypeFine <- j
  de_g$gene <- rownames(de_g)
  
  DGE_list[[j]] <- de_g
  
  saveRDS(fit, paste0("../results/DGEfit_patientGroups_celltypeFine_", j,".rds"))
  write.csv(de_g, paste0("../results/DGE_patientGroups_celltypeFine_", j,".csv"), row.names = TRUE)

}

saveRDS(DGE_list, paste0("../results/DGE_patientGroups_celltypeFine_listAll.rds"))


```


## dotplots for top expressed genes

```{r }

#get top expressed genes
tmp <- lapply(DGE_list, function(x){head(x, n = 20)})
tmp <- do.call("rbind", tmp)

# !!!! fix this !!!!

detable$groups <- paste0(detable$cell_cluster, detable$cluster)
detable %>% group_by(groups)  %>% top_n(-60, p_val) %>% top_n(40, pct.diff) %>% top_n(20, log.pct.diff) -> top5
ord <- factor(sapply(unique(as.character(top5$gene)), function(x){getcluster(DGE_DATA, x, "subgroups")}))
ord

pdf( paste0("../results/DGE_B-cells_perPatientperCluster.pdf"),width = 20,height = length(ord)/6+2)
mypar(1,1,mar=c(15,6,1,5))
plot_dots(DGE_DATA, unique(as.character(top5$gene))[order(as.numeric( as.character(ord) ))], clustering = "subgroups", show_grid = T,main = "top cluster markers",cex.main=1,font.main=1,cex.col = 1,srt = 90,cex.row = 1.1)
abline(v=cumsum(c(table(sub( "_.*","",names(table(DGE_DATA$subgroups))))))+0.5)
dev.off()

```



## DE between VH mutation classes for memory B-cells

```{r }



```


## Save rds 

```{r}

#saveRDS(gex, file = "../results/xxx.rds")

```


## Print sessionInfo()

```{r}

sessionInfo()

```



